<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý Giáo Án AI - Trần Lịch Sử</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --accent-color: #198754;
            --bg-color: #f0f2f5;
            --card-radius: 12px;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', sans-serif;
            color: #333;
            padding-bottom: 50px;
        }

        /* Header Styling */
        .main-header {
            background: linear-gradient(135deg, #005bea 0%, #00c6fb 100%);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Card Styling */
        .custom-card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: none;
            height: 100%;
            transition: transform 0.2s;
        }

        .card-header-custom {
            padding: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            background: #fff;
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Form Elements */
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 0.4rem;
        }

        .form-select, .form-control {
            border-radius: 8px;
            padding: 0.7rem;
            border: 1px solid #dee2e6;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }

        /* Buttons */
        .btn-action {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            border: none;
            color: white;
            font-weight: 700;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(56, 239, 125, 0.3);
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 239, 125, 0.4);
            color: white;
        }

        /* Result Area */
        #resultArea {
            padding: 40px;
            font-family: 'Times New Roman', serif;
            font-size: 13pt;
            line-height: 1.5;
            color: #000;
            background: white;
            min-height: 600px;
        }

        /* Table Styling inside Result */
        #resultArea table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        #resultArea th, #resultArea td {
            border: 1px solid #000;
            padding: 8px;
            vertical-align: top;
        }

        #resultArea th {
            background-color: #f8f9fa;
            text-align: center;
            font-weight: bold;
        }

        /* Nav Pills */
        .nav-pills .nav-link {
            border-radius: 8px;
            color: #555;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .geo-badge {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ffeeba;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="main-header text-center">
        <div class="container">
            <h1 class="fw-bold mb-0"><i class="fas fa-chalkboard-teacher me-2"></i>TRỢ LÝ GIÁO ÁN AI</h1>
        </div>
    </header>

    <div class="container">
        <div class="row g-4">
            
            <!-- CỘT TRÁI: ĐIỀU KHIỂN -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <span><i class="fas fa-cogs"></i> THIẾT LẬP BÀI DẠY</span>
                    </div>
                    <div class="card-body p-4">
                        
                        <!-- API Key Input -->
                        <div class="mb-3">
                            <label class="form-label text-primary">Gemini API Key</label>
                            <div class="input-group">
                                <input type="password" id="apiKey" class="form-control" placeholder="Dán khóa API vào đây..." onchange="saveKey()">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiVisibility()">
                                    <i class="fas fa-eye" id="eyeIcon"></i>
                                </button>
                            </div>
                        </div>

                        <hr class="my-3">

                        <!-- Tabs -->
                        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tab-new" data-bs-toggle="pill" data-bs-target="#content-new" type="button">
                                    <i class="fas fa-plus-circle me-1"></i> Soạn Mới
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-upgrade" data-bs-toggle="pill" data-bs-target="#content-upgrade" type="button">
                                    <i class="fas fa-upload me-1"></i> Nâng Cấp File
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="pills-tabContent">
                            
                            <!-- Tab Soạn Mới -->
                            <div class="tab-pane fade show active" id="content-new">
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <label class="form-label">Bộ sách</label>
                                        <select id="bookSet" class="form-select" onchange="loadLessons()">
                                            <option value="Cánh Diều">Cánh Diều</option>
                                            <option value="Chân trời sáng tạo">Chân trời sáng tạo</option>
                                            <option value="Kết nối tri thức">Kết nối tri thức</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Khối lớp</label>
                                        <select id="grade" class="form-select" onchange="loadLessons()">
                                            <option value="5">Lớp 5</option>
                                            <option value="4">Lớp 4</option>
                                            <option value="3">Lớp 3</option>
                                            <option value="2">Lớp 2</option>
                                            <option value="1">Lớp 1</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Môn học</label>
                                    <select id="subject" class="form-select" onchange="loadLessons()">
                                        <option>Tiếng Việt</option>
                                        <option>Toán</option>
                                        <option>Khoa học</option>
                                        <option>Lịch sử và Địa lí</option>
                                        <option>Đạo đức</option>
                                        <option>Tin học</option>
                                        <option>Công nghệ</option>
                                        <option>Hoạt động trải nghiệm</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tên bài dạy</label>
                                    <input list="lessonList" id="lessonName" class="form-control" placeholder="Nhập tên bài hoặc chọn...">
                                    <datalist id="lessonList"></datalist>
                                </div>

                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label">Số tiết</label>
                                        <input type="number" id="totalPeriods" class="form-control" value="1" min="1">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Tiết thứ</label>
                                        <input type="text" id="currentPeriod" class="form-control" value="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Nâng Cấp -->
                            <div class="tab-pane fade" id="content-upgrade">
                                <div class="mb-3">
                                    <label class="form-label">Chọn file Word (.docx)</label>
                                    <input type="file" id="oldFile" class="form-control" accept=".docx">
                                    <div class="form-text mt-2 small text-muted">
                                        Hệ thống sẽ đọc file, giữ nguyên nội dung gốc và bổ sung các cột, hoạt động tích hợp theo chuẩn 2345 và cập nhật địa danh mới.
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="mt-4">
                            <button class="btn btn-action" onclick="processPlan()">
                                <i class="fas fa-magic me-2"></i> THỰC HIỆN NGAY
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CỘT PHẢI: KẾT QUẢ -->
            <div class="col-lg-8">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div><i class="fas fa-file-alt text-primary"></i> KẾT QUẢ GIÁO ÁN</div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="copyResult()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="printResult()">
                                <i class="fas fa-file-pdf"></i> In / PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="resultArea">
                            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                                <i class="fas fa-robot fa-4x mb-3 text-secondary opacity-25"></i>
                                <p>Kết quả soạn thảo sẽ hiển thị tại đây.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thông báo -->
    <div class="modal fade" id="alertModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-danger"><i class="fas fa-exclamation-circle"></i> Thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="alertMessage"></div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Đã hiểu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="fw-bold text-primary">AI ĐANG SUY NGHĨ...</h4>
        <p class="text-muted" id="loadingText">Đang phân tích dữ liệu và áp dụng quy hoạch 34 tỉnh thành...</p>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        // --- 1. CONFIGURATION & DATA ---
        
        // Cấu hình quy tắc địa lý 34 tỉnh thành (QUAN TRỌNG)
        const GEO_RULE_PROMPT = `
*** QUY TẮC ĐỊA LÍ TUYỆT ĐỐI: TƯ DUY BẢN ĐỒ 34 TỈNH ***
Bối cảnh: Việt Nam đã sáp nhập từ 63 tỉnh/thành xuống còn 34 đơn vị hành chính cấp tỉnh.

I. QUY TẮC TIẾP GIÁP CỤ THỂ VÙNG HÀ NỘI:
Hà Nội (Mới) chỉ giáp với:
- Phú Thọ (Gồm Vĩnh Phúc, Hòa Bình cũ).
- Thái Nguyên (Gồm Thái Nguyên cũ, Bắc Kạn).
- Bắc Ninh (Gồm Bắc Ninh cũ, Bắc Giang).
- Hưng Yên (Gồm Hưng Yên cũ, Thái Bình).
- Ninh Bình (Gồm Ninh Bình cũ, Hà Nam, Nam Định).
-> TUYỆT ĐỐI KHÔNG LIỆT KÊ Tuyên Quang, Lạng Sơn là tỉnh giáp Hà Nội (Vì bị ngăn cách bởi các tỉnh trên).

II. QUY TẮC SUY LUẬN CHUNG (Dành cho các tỉnh khác):
Dựa vào thành phần cấu tạo để xác định giáp ranh:

1. KHU VỰC MIỀN BẮC:
- Tuyên Quang (Mới) = Gồm Tuyên Quang cũ + Hà Giang.
- Lào Cai (Mới) = Gồm Lào Cai cũ + Yên Bái.
- Thái Nguyên (Mới) = Gồm Thái Nguyên cũ + Bắc Kạn.
- Phú Thọ (Mới) = Gồm Phú Thọ cũ + Vĩnh Phúc + Hòa Bình.
- Bắc Ninh (Mới) = Gồm Bắc Ninh cũ + Bắc Giang.
- Hưng Yên (Mới) = Gồm Hưng Yên cũ + Thái Bình.
- Ninh Bình (Mới) = Gồm Ninh Bình cũ + Hà Nam + Nam Định.
- Hải Phòng (Mới) = Gồm Hải Phòng cũ + Hải Dương.
- Giữ nguyên: Hà Nội, Cao Bằng, Lạng Sơn, Lai Châu, Điện Biên, Sơn La, Quảng Ninh.

2. KHU VỰC MIỀN TRUNG & TÂY NGUYÊN:
- Quảng Trị (Mới) = Gồm Quảng Trị cũ + Quảng Bình.
- Đà Nẵng (Mới) = Gồm Đà Nẵng cũ + Quảng Nam.
- Quảng Ngãi (Mới) = Gồm Quảng Ngãi cũ + Kon Tum.
- Gia Lai (Mới) = Gồm Gia Lai cũ + Bình Định.
- Đắk Lắk (Mới) = Gồm Đắk Lắk cũ + Phú Yên.
- Khánh Hòa (Mới) = Gồm Khánh Hòa cũ + Ninh Thuận.
- TP. Huế: Thừa Thiên Huế cũ.
- Giữ nguyên: Thanh Hóa, Nghệ An, Hà Tĩnh.

3. KHU VỰC MIỀN NAM:
- Lâm Đồng (Mới) = Gồm Lâm Đồng cũ + Đắk Nông + Bình Thuận.
- Đồng Nai (Mới) = Gồm Đồng Nai cũ + Bình Phước.
- Tây Ninh (Mới) = Gồm Tây Ninh cũ + Long An.
- TP. Hồ Chí Minh (Mới) = Gồm TP.HCM cũ + Bình Dương + Bà Rịa Vũng Tàu.
- Đồng Tháp (Mới) = Gồm Đồng Tháp cũ + Tiền Giang.
- An Giang (Mới) = Gồm An Giang cũ + Kiên Giang.
- Vĩnh Long (Mới) = Gồm Vĩnh Long cũ + Trà Vinh + Bến Tre.
- Cần Thơ (Mới) = Gồm Cần Thơ cũ + Hậu Giang + Sóc Trăng.
- Cà Mau (Mới) = Gồm Cà Mau cũ + Bạc Liêu.

LƯU Ý KHI SOẠN BÀI: 
- Nếu bài học có nhắc đến địa phương, PHẢI dùng tên tỉnh mới.
- Tuyệt đối không dùng tên tỉnh cũ như một đơn vị hành chính độc lập.
`;

        // Database bài học mẫu (Cánh Diều Lớp 5 & 4 - Mở rộng thêm nếu cần)
        const LESSON_DB = {
            "Cánh Diều": {
                "5": {
                    "Tiếng Việt": [
                        "Bài 1: Trẻ em như búp trên cành", "Bài 2: Bạn nam, bạn nữ", "Bài 3: Có chí thì nên", "Bài 4: Cánh cánh ước mơ", "Bài 5: Măng non Việt Nam", "Bài 6: Ngôi nhà chung", "Bài 7: Vì hạnh phúc con người", "Bài 8: Giữ gìn môi trường xanh - sạch - đẹp", "Ôn tập giữa học kì 1", "Bài 9: Vì hòa bình", "Bài 10: Tình hữu nghị", "Bài 11: Khám phá thế giới", "Bài 12: Chung tay bảo vệ môi trường", "Ôn tập cuối học kì 1", "Bài 13: Cuộc sống quanh ta", "Bài 14: Vẻ đẹp cuộc sống", "Bài 15: Giữ gìn trật tự, an ninh", "Bài 16: Quyền và bổn phận", "Bài 17: Vì cuộc sống an toàn", "Bài 18: Vì cuộc sống bình yên", "Bài 19: Ôn tập cuối năm"
                    ],
                    "Toán": [
                        "Bài 1: Ôn tập về số tự nhiên", "Bài 2: Ôn tập về các phép tính với số tự nhiên", "Bài 3: Ôn tập về giải toán", "Bài 4: Ôn tập và bổ sung về phân số", "Bài 5: Ôn tập và bổ sung về các phép tính với phân số", "Bài 6: Giới thiệu về tỉ số", "Bài 7: Tìm hai số khi biết tổng và tỉ số của hai số đó", "Bài 8: Tìm hai số khi biết hiệu và tỉ số của hai số đó", "Bài 9: Bài toán liên quan đến quan hệ phụ thuộc", "Bài 10: Luyện tập chung", "Bài 11: Hỗn số", "Bài 12: Phân số thập phân", "Bài 13: Số thập phân", "Bài 14: Hàng của số thập phân. Đọc, viết số thập phân", "Bài 15: Số thập phân bằng nhau", "Bài 16: So sánh hai số thập phân", "Bài 17: Viết các số đo độ dài dưới dạng số thập phân", "Bài 18: Viết các số đo khối lượng dưới dạng số thập phân", "Bài 19: Viết các số đo diện tích dưới dạng số thập phân", "Bài 20: Luyện tập chung", "Bài 21: Cộng hai số thập phân", "Bài 22: Trừ hai số thập phân", "Bài 23: Nhân một số thập phân với một số tự nhiên", "Bài 24: Nhân một số thập phân với 10, 100, 1000,...", "Bài 25: Nhân một số thập phân với một số thập phân", "Bài 26: Chia một số thập phân cho một số tự nhiên", "Bài 27: Chia một số thập phân cho 10, 100, 1000,...", "Bài 28: Chia một số tự nhiên cho một số tự nhiên mà thương là một số thập phân", "Bài 29: Chia một số tự nhiên cho một số thập phân", "Bài 30: Chia một số thập phân cho một số thập phân", "Bài 31: Luyện tập chung", "Bài 32: Tỉ số phần trăm", "Bài 33: Giải toán về tỉ số phần trăm", "Bài 34: Giải toán về tỉ số phần trăm (tiếp)", "Bài 35: Giải toán về tỉ số phần trăm (tiếp theo)", "Bài 36: Luyện tập chung", "Bài 37: Hình tam giác", "Bài 38: Diện tích hình tam giác", "Bài 39: Hình thang", "Bài 40: Diện tích hình thang", "Bài 41: Hình tròn. Đường tròn", "Bài 42: Chu vi hình tròn", "Bài 43: Diện tích hình tròn", "Bài 44: Luyện tập chung", "Bài 45: Sử dụng máy tính bỏ túi", "Bài 53: Thể tích của một hình", "Bài 54: Xăng-ti-mét khối. Đề-xi-mét khối", "Bài 55: Mét khối", "Bài 56: Thể tích hình hộp chữ nhật", "Bài 57: Thể tích hình lập phương", "Bài 58: Luyện tập chung", "Bài 59: Giới thiệu biểu đồ hình quạt tròn", "Bài 60: Biểu đồ hình quạt tròn (tiếp theo)", "Bài 61: Luyện tập chung", "Bài 62: Thời gian", "Bài 63: Cộng số đo thời gian", "Bài 64: Trừ số đo thời gian", "Bài 65: Nhân số đo thời gian với một số", "Bài 66: Chia số đo thời gian cho một số", "Bài 67: Vận tốc", "Bài 68: Quãng đường", "Bài 69: Thời gian", "Bài 70: Bài toán về chuyển động đều", "Bài 71: Chuyển động ngược chiều", "Bài 72: Chuyển động cùng chiều", "Bài 73: Luyện tập chung", "Bài 74: Ôn tập về số tự nhiên", "Bài 75: Ôn tập về phân số", "Bài 76: Ôn tập về số thập phân", "Bài 77: Ôn tập về đo đại lượng", "Bài 78: Ôn tập về chu vi, diện tích một số hình", "Bài 79: Ôn tập về thể tích một số hình", "Bài 80: Ôn tập về giải toán", "Bài 81: Ôn tập về biểu đồ"
                    ],
                    "Khoa học": [
                        "Bài 1: Đất và sự sống", "Bài 2: Nước và sự sống", "Bài 3: Không khí và sự bảo vệ môi trường không khí", "Bài 4: Năng lượng chất đốt", "Bài 5: Năng lượng điện", "Bài 6: Năng lượng mặt trời, gió và nước chảy", "Bài 7: Các nguồn năng lượng", "Bài 8: Sự sinh sản của thực vật có hoa", "Bài 9: Sự lớn lên và phát triển của thực vật", "Bài 10: Sự sinh sản của động vật", "Bài 11: Sự lớn lên và phát triển của động vật", "Bài 12: Vòng đời của động vật", "Bài 13: Vi khuẩn", "Bài 14: Phòng bệnh do vi khuẩn gây ra", "Bài 15: Cơ thể người và sự phát triển", "Bài 16: Chăm sóc sức khoẻ tuổi dậy thì", "Bài 17: Phòng tránh bị xâm hại", "Bài 18: An toàn giao thông", "Bài 19: Bảo vệ môi trường đất", "Bài 20: Bảo vệ môi trường nước", "Bài 21: Bảo vệ môi trường không khí", "Bài 22: Sử dụng năng lượng tiết kiệm và hiệu quả"
                    ],
                    "Lịch sử và Địa lí": [
                        "Bài 1: Vị trí địa lí, lãnh thổ, đơn vị hành chính, Quốc kì, Quốc huy, Quốc ca Việt Nam", "Bài 2: Thiên nhiên Việt Nam", "Bài 3: Biển, đảo Việt Nam", "Bài 4: Dân cư và dân tộc ở Việt Nam", "Bài 5: Nước Văn Lang, Âu Lạc", "Bài 6: Vương quốc Phù Nam", "Bài 7: Vương quốc Chăm-pa", "Bài 8: Đấu tranh giành độc lập thời kì Bắc thuộc", "Bài 9: Triều Lý và việc định đô ở Thăng Long", "Bài 10: Triều Trần và kháng chiến chống Mông – Nguyên", "Bài 11: Khởi nghĩa Lam Sơn và triều Hậu Lê", "Bài 12: Triều Nguyễn", "Bài 13: Cách mạng tháng Tám năm 1945", "Bài 14: Chiến dịch Điện Biên Phủ năm 1954", "Bài 15: Chiến dịch Hồ Chí Minh năm 1975", "Bài 16: Đất nước Đổi mới", "Bài 17: Các nước láng giềng của Việt Nam", "Bài 18: Hiệp hội các quốc gia Đông Nam Á (ASEAN)", "Bài 19: Thế giới quanh ta", "Bài 20: Chung tay xây dựng thế giới hoà bình"
                    ],
                    "Đạo đức": [
                        "Bài 1: Người công dân tí hon", "Bài 2: Em yêu Tổ quốc Việt Nam", "Bài 3: Em yêu hoà bình", "Bài 4: Có trách nhiệm về việc làm của mình", "Bài 5: Tôn trọng sự khác biệt", "Bài 6: Nhận lỗi và sửa lỗi", "Bài 7: Bảo vệ cái đúng, cái tốt", "Bài 8: Bảo vệ môi trường sống", "Bài 9: Em yêu lao động", "Bài 10: Em lập kế hoạch cá nhân", "Bài 11: Phòng tránh bị xâm hại", "Bài 12: Sử dụng tiền hợp lí"
                    ]
                },
                "4": {
                    "Lịch sử và Địa lí": [
                        "Bài 1: Làm quen với phương tiện học tập môn Lịch sử và Địa lí", "Bài 2: Địa phương em (Tỉnh, thành phố trực thuộc Trung ương)", "Bài 3: Thiên nhiên vùng Trung du và miền núi Bắc Bộ", "Bài 4: Dân cư, hoạt động sản xuất và một số nét văn hoá ở vùng Trung du và miền núi Bắc Bộ", "Bài 5: Đền Hùng và lễ giỗ Tổ Hùng Vương", "Bài 6: Thiên nhiên vùng Đồng bằng Bắc Bộ", "Bài 7: Dân cư, hoạt động sản xuất và một số nét văn hoá ở vùng Đồng bằng Bắc Bộ", "Bài 8: Sông Hồng và văn minh sông Hồng", "Bài 9: Thăng Long – Hà Nội", "Bài 10: Văn Miếu – Quốc Tử Giám", "Bài 11: Thiên nhiên vùng Duyên hải miền Trung", "Bài 12: Dân cư, hoạt động sản xuất và một số nét văn hoá ở vùng Duyên hải miền Trung", "Bài 13: Cố đô Huế", "Bài 14: Phố cổ Hội An", "Bài 15: Thiên nhiên vùng Tây Nguyên", "Bài 16: Dân cư, hoạt động sản xuất và một số nét văn hoá ở vùng Tây Nguyên", "Bài 17: Lễ hội Cồng chiêng Tây Nguyên", "Bài 18: Thiên nhiên vùng Nam Bộ", "Bài 19: Dân cư, hoạt động sản xuất và một số nét văn hoá ở vùng Nam Bộ", "Bài 20: Thành phố Hồ Chí Minh", "Bài 21: Địa đạo Củ Chi"
                    ]
                }
            }
        };

        // DOM Elements
        const els = {};

        // --- 2. INITIALIZATION ---
        window.onload = () => {
            // Mapping elements
            ['apiKey', 'bookSet', 'grade', 'subject', 'lessonName', 'lessonList', 
             'totalPeriods', 'currentPeriod', 'oldFile', 'resultArea', 
             'loadingOverlay', 'loadingText', 'eyeIcon', 'alertMessage'].forEach(id => {
                els[id] = document.getElementById(id);
            });

            // Load saved key
            const savedKey = localStorage.getItem("gemini_key");
            if (savedKey) els.apiKey.value = savedKey;

            // Load initial lessons
            loadLessons();
            
            // Modal instance
            els.modal = new bootstrap.Modal(document.getElementById('alertModal'));
        };

        // --- 3. HELPER FUNCTIONS ---

        function showAlert(msg) {
            els.alertMessage.innerText = msg;
            els.modal.show();
        }

        function saveKey() {
            localStorage.setItem("gemini_key", els.apiKey.value);
        }

        function toggleApiVisibility() {
            if (els.apiKey.type === "password") {
                els.apiKey.type = "text";
                els.eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                els.apiKey.type = "password";
                els.eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function loadLessons() {
            const b = els.bookSet.value;
            const g = els.grade.value;
            const s = els.subject.value;
            
            els.lessonList.innerHTML = "";
            
            if (LESSON_DB[b] && LESSON_DB[b][g] && LESSON_DB[b][g][s]) {
                LESSON_DB[b][g][s].forEach(l => {
                    const opt = document.createElement('option');
                    opt.value = l;
                    els.lessonList.appendChild(opt);
                });
            }
        }

        // --- 4. MAIN LOGIC ---

        async function processPlan() {
            // 1. Validation
            if (!els.apiKey.value) {
                showAlert("Vui lòng nhập Gemini API Key!");
                return;
            }

            const isNewMode = document.getElementById('tab-new').classList.contains('active');
            let systemInstruction = "";
            let userPrompt = "";

            // --- LOGIC XÁC ĐỊNH MÃ NĂNG LỰC SỐ (NLS) CHÍNH XÁC ---
            const selectedGrade = parseInt(els.grade.value);
            const isPrimaryLow = selectedGrade <= 3; // Lớp 1, 2, 3
            
            // Tạo quy tắc và ví dụ động dựa trên khối lớp
            const nlsRule = isPrimaryLow 
                ? "LỚP 1, 2, 3 -> BẮT BUỘC DÙNG MÃ CẤP ĐỘ 1 (có đuôi .CB1, .CB1a, .CB1b...). TUYỆT ĐỐI KHÔNG DÙNG MÃ .CB2." 
                : "LỚP 4, 5 -> BẮT BUỘC DÙNG MÃ CẤP ĐỘ 2 (có đuôi .CB2, .CB2a, .CB2b...). TUYỆT ĐỐI KHÔNG DÙNG MÃ .CB1.";
            
            const nlsExample = isPrimaryLow 
                ? "NLS 1.1.CB1a: Tìm kiếm thông tin đơn giản" 
                : "NLS 1.1.CB2a: Xác định từ khóa tìm kiếm";

            // 2. Determine Mode & Build Prompt
            if (isNewMode) {
                if (!els.lessonName.value) {
                    showAlert("Vui lòng nhập tên bài dạy!");
                    return;
                }

                systemInstruction = `Bạn là Trợ lý Giáo án chuyên nghiệp, tuân thủ Công văn 2345/BGDĐT-GDTH.
${GEO_RULE_PROMPT}

*** QUY TẮC NĂNG LỰC SỐ (NLS) ***
${nlsRule}

Nhiệm vụ: Soạn giáo án mới.
`;
                userPrompt = `
Thông tin bài dạy:
- Bộ sách: ${els.bookSet.value}
- Lớp: ${els.grade.value}
- Môn: ${els.subject.value}
- Bài: ${els.lessonName.value}
- Thời lượng: ${els.totalPeriods.value} tiết (Soạn tiết: ${els.currentPeriod.value})

YÊU CẦU CẤU TRÚC (BẮT BUỘC):
I. Yêu cầu cần đạt:
   - Tóm tắt những ý cơ bản, cốt lõi nhất bằng các gạch đầu dòng (-).
   - RIÊNG VỚI NỘI DUNG TÍCH HỢP: Phải trình bày thành các gạch đầu dòng riêng biệt, không viết gộp.
     Định dạng chuẩn: - **[Mã]**: [Nội dung tích hợp].
     Ví dụ:
     - **ANQP**: Giáo dục ý thức bảo vệ chủ quyền biển đảo.
     - **BVMT**: Giữ gìn vệ sinh môi trường xung quanh.
     - **NLS ${isPrimaryLow ? '1.1.CB1a' : '1.1.CB2a'}**: ${isPrimaryLow ? 'Tìm kiếm thông tin đơn giản' : 'Xác định từ khóa tìm kiếm'}.

II. Đồ dùng dạy học.

III. Các hoạt động dạy học chủ yếu:
   Tạo BẢNG 2 CỘT: | Hoạt động của Giáo viên | Hoạt động của Học sinh |
   
   *Yêu cầu nội dung:*
   - Hoạt động HS: Viết chi tiết câu trả lời/hành động, KHÔNG viết "HS trả lời".
   - Tích hợp Năng lực số (NLS): CHỈ tích hợp trong mục I (Yêu cầu cần đạt) và mục III (Các hoạt động dạy học). 
   - Định dạng bắt buộc: **NLS [Mã]: [Nội dung]** (VD: **${nlsExample}**).
   - Lưu ý quan trọng: Bài này là Lớp ${selectedGrade}, hãy chọn mã chỉ báo phù hợp với quy tắc trên.
   - Tích hợp Địa lí: Nếu bài có nhắc đến địa danh, hãy kiểm tra quy tắc 34 tỉnh thành và dùng tên mới.
   - Tích hợp khác: BVMT (Môi trường), ANQP (Quốc phòng), Quyền trẻ em.

IV. Điều chỉnh sau bài dạy.
`;

            } else {
                // Upgrade Mode
                if (!els.oldFile.files.length) {
                    showAlert("Vui lòng chọn file Word (.docx) để nâng cấp!");
                    return;
                }

                els.loadingOverlay.style.display = "flex";
                els.loadingText.innerText = "Đang đọc nội dung file Word...";

                try {
                    const arrayBuffer = await els.oldFile.files[0].arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    const fileContent = result.value;

                    if (!fileContent.trim()) throw new Error("File trống!");

                    systemInstruction = `Bạn là Trợ lý Giáo án.
${GEO_RULE_PROMPT}

*** QUY TẮC NĂNG LỰC SỐ (NLS) ***
${nlsRule}
(Hãy kiểm tra nội dung bài để đảm bảo mã NLS phù hợp với độ tuổi học sinh Lớp ${selectedGrade}).

NGUYÊN TẮC CỐT LÕI: TÔN TRỌNG NỘI DUNG GỐC (Trừ phần Yêu cầu cần đạt).`;

                    userPrompt = `
DỮ LIỆU GIÁO ÁN CŨ:
"""
${fileContent}
"""

YÊU CẦU XỬ LÝ:
1. RIÊNG PHẦN I (YÊU CẦU CẦN ĐẠT): 
   - Hãy viết tóm tắt những ý cơ bản, ngắn gọn bằng các gạch đầu dòng (-).
   - Các nội dung tích hợp phải được viết thành dòng riêng biệt với gạch đầu dòng (-). Định dạng: - **[Mã]**: [Nội dung].
2. CÁC PHẦN CÒN LẠI: GIỮ NGUYÊN văn phong, nội dung và hình thức trình bày của giáo án cũ. KHÔNG viết lại, KHÔNG tóm tắt, KHÔNG tự ý kẻ bảng nếu bản gốc không có.
3. CHỈ THỰC HIỆN CÁC THAY ĐỔI SAU (Chèn thêm vào vị trí phù hợp bằng chữ in đậm):
   - Tích hợp Năng lực số (NLS): Chỉ chèn vào mục I (Yêu cầu cần đạt) và các hoạt động dạy học. Viết tắt theo định dạng: **NLS [Mã]: [Nội dung]** (VD: **${nlsExample}**).
   - Tích hợp nội dung khác (BVMT, ANQP, Quyền trẻ em): Chèn nội dung tích hợp vào hoạt động liên quan (VD: **[Tích hợp BVMT: Giữ vệ sinh lớp học]**).
   - Cập nhật Địa danh: Nếu bài cũ nhắc đến tỉnh cũ (VD: Bắc Kạn), hãy sửa thành tên tỉnh mới (Thái Nguyên) theo quy tắc 34 tỉnh.

Kết quả trả về là nội dung giáo án cũ được giữ nguyên cấu trúc (trừ phần I được format lại) và đã có thêm các phần tích hợp.
`;
                } catch (e) {
                    els.loadingOverlay.style.display = "none";
                    showAlert("Lỗi đọc file: " + e.message);
                    return;
                }
            }

            // 3. Call AI
            await callGemini(systemInstruction, userPrompt);
        }

        async function callGemini(sys, user) {
            els.loadingOverlay.style.display = "flex";
            els.loadingText.innerText = "AI đang đối chiếu bản đồ 34 tỉnh thành và soạn bài...";

            try {
                // Sử dụng model gemini-2.5-flash-preview-09-2025 (mới nhất hỗ trợ tiếng Việt tốt)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${els.apiKey.value}`;
                
                const payload = {
                    contents: [{ parts: [{ text: user }] }],
                    systemInstruction: { parts: [{ text: sys }] }
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(response.statusText);

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Không có nội dung trả về.";

                // Render Markdown
                els.resultArea.innerHTML = marked.parse(aiText);

            } catch (error) {
                console.error(error);
                els.resultArea.innerHTML = `<div class="alert alert-danger">
                    <h5><i class="fas fa-bug"></i> Lỗi xử lý</h5>
                    <p>${error.message}</p>
                </div>`;
            } finally {
                els.loadingOverlay.style.display = "none";
            }
        }

        // --- 5. EXPORT FUNCTIONS ---
        function copyResult() {
            if (!els.resultArea.innerText.trim()) return;
            const range = document.createRange();
            range.selectNode(els.resultArea);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            // Show toast/notification (optional)
            const btn = event.currentTarget;
            const originHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Đã Copy';
            setTimeout(() => btn.innerHTML = originHtml, 2000);
        }

        function printResult() {
            if (!els.resultArea.innerText.trim()) return;
            const w = window.open();
            w.document.write(`
                <html><head><title>Giáo Án 2345 (34 Tỉnh)</title>
                <style>
                    body{font-family:'Times New Roman',serif;font-size:13pt;padding:20px;line-height:1.5}
                    table{width:100%;border-collapse:collapse;margin:15px 0}
                    td,th{border:1px solid #000;padding:5px;vertical-align:top}
                    h1,h2,h3{text-align:center;text-transform:uppercase}
                </style>
                </head><body>${els.resultArea.innerHTML}</body></html>
            `);
            w.document.close();
            w.print();
        }
    </script>
</body>

</html>
